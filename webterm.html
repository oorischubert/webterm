<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <title>WebTerm</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
  <style>
    .glass {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.88));
      backdrop-filter: blur(14px);
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 24px 70px rgba(2, 6, 23, 0.55);
    }

    .modern-scroll {
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.65) transparent;
    }

    .modern-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .modern-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .modern-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .badge-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 6px;
    }

  </style>
</head>

<body class="min-h-screen bg-slate-950 text-white selection:bg-sky-300/20 selection:text-sky-100">
  <div class="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_20%_20%,rgba(56,189,248,0.15),transparent_45%),radial-gradient(circle_at_80%_0%,rgba(244,63,94,0.18),transparent_42%),radial-gradient(circle_at_50%_90%,rgba(34,197,94,0.15),transparent_35%)]">
  </div>

  <main class="mx-auto max-w-7xl px-4 pb-8 pt-8 sm:px-6 lg:px-8">
    <header class="mb-7 text-center">
      <h1 class="text-5xl font-black tracking-tight sm:text-6xl">WebTerm</h1>
    </header>

    <section class="grid gap-4 lg:grid-cols-3">
      <article class="glass rounded-2xl p-4 lg:col-span-2">
        <h2 class="mb-3 text-sm font-semibold uppercase tracking-[0.2em] text-slate-300">Scan Website</h2>
        <form id="scanForm" class="space-y-3">
          <label for="scanUrl" class="text-xs font-medium text-slate-300">Root URL</label>
          <div class="flex flex-col gap-2 sm:flex-row">
            <input id="scanUrl" type="text" placeholder="https://example.com"
              class="w-full rounded-xl border border-white/15 bg-slate-900/70 px-3 py-2 text-sm outline-none ring-0 transition focus:border-sky-300/40" required />
            <button type="submit"
              class="rounded-xl bg-sky-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-400">
              <i class="fa-solid fa-magnifying-glass mr-1"></i> Scan
            </button>
          </div>
        </form>

        <div class="mt-4 grid gap-2 sm:grid-cols-4">
          <button id="refreshBtn"
            class="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:bg-white/10">
            Refresh
          </button>
          <button id="clearBtn"
            class="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:bg-white/10">
            Clear
          </button>
          <button id="saveBtn"
            class="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:bg-white/10">
            Save Tree
          </button>
          <button id="loadBtn"
            class="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:bg-white/10">
            Load Tree
          </button>
        </div>

        <div class="mt-3">
          <input id="treeFilename" type="text" placeholder="tree filename (e.g. mysite.json)"
            class="w-full rounded-xl border border-white/15 bg-slate-900/70 px-3 py-2 text-xs text-slate-300 outline-none transition focus:border-sky-300/40" />
        </div>

        <p id="actionMessage" class="mt-3 text-xs text-slate-300"></p>
      </article>

      <article class="glass rounded-2xl p-4">
        <h2 class="mb-3 text-sm font-semibold uppercase tracking-[0.2em] text-slate-300">Connection</h2>
        <div class="space-y-3">
          <div>
            <label for="apiBase" class="text-xs text-slate-300">API Base</label>
            <input id="apiBase" type="text"
              class="mt-1 w-full rounded-xl border border-white/15 bg-slate-900/70 px-3 py-2 text-xs outline-none transition focus:border-sky-300/40" />
          </div>
          <div>
            <label for="apiKey" class="text-xs text-slate-300">API Key</label>
            <input id="apiKey" type="text"
              class="mt-1 w-full rounded-xl border border-white/15 bg-slate-900/70 px-3 py-2 text-xs outline-none transition focus:border-sky-300/40" />
          </div>
          <button id="saveSettingsBtn"
            class="w-full rounded-xl bg-emerald-500 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-white transition hover:bg-emerald-400">
            Save Settings
          </button>
          <p id="connectionMessage" class="text-xs text-slate-300"></p>
          <p id="connectionStatus" class="text-xs text-slate-300">Checking connection...</p>
        </div>
      </article>
    </section>

    <section class="mt-4 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
      <article class="glass rounded-2xl p-4">
        <p class="text-xs uppercase tracking-wider text-slate-300">Agent Status</p>
        <p id="statusBusy" class="mt-2 text-2xl font-bold">Idle</p>
      </article>
      <article class="glass rounded-2xl p-4">
        <p class="text-xs uppercase tracking-wider text-slate-300">Current Root</p>
        <p id="statusRoot" class="mt-2 truncate text-sm font-semibold text-slate-100">-</p>
      </article>
      <article class="glass rounded-2xl p-4">
        <p class="text-xs uppercase tracking-wider text-slate-300">Pages</p>
        <p id="statusPages" class="mt-2 text-2xl font-bold">0</p>
      </article>
      <article class="glass rounded-2xl p-4">
        <p class="text-xs uppercase tracking-wider text-slate-300">Items</p>
        <p id="statusItems" class="mt-2 text-2xl font-bold">0</p>
      </article>
    </section>

    <section class="mt-4 grid gap-4 xl:grid-cols-3">
      <article class="glass min-w-0 rounded-2xl p-4 xl:col-span-1">
        <div class="mb-3 flex items-center justify-between">
          <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-slate-300">Scan Progress</h2>
          <button id="refreshListBtn" class="rounded-md border border-white/15 px-2 py-1 text-xs hover:bg-white/10">Reload</button>
        </div>
        <div id="responseList" class="modern-scroll min-w-0 max-h-[460px] space-y-2 overflow-y-auto pr-1"></div>
      </article>

      <article class="glass rounded-2xl p-4 xl:col-span-2">
        <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
          <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-slate-300">SiteTree Viewer</h2>
          <div class="flex gap-2 text-xs">
            <button id="treeTextBtn" class="rounded-md border border-white/15 px-2 py-1 hover:bg-white/10">Tree Text</button>
            <button id="treeJsonBtn" class="rounded-md border border-white/15 px-2 py-1 hover:bg-white/10">Tree JSON</button>
            <button id="refreshTreeBtn" class="rounded-md border border-white/15 px-2 py-1 hover:bg-white/10">Refresh</button>
          </div>
        </div>
        <pre id="treeOutput"
          class="modern-scroll min-h-[240px] max-h-[460px] overflow-auto rounded-xl border border-white/10 bg-slate-900/70 p-3 text-xs leading-relaxed text-slate-100"></pre>
      </article>
    </section>

    <section class="mt-4">
      <article class="glass rounded-2xl p-4">
        <div class="mb-3 flex items-center justify-between gap-2">
          <h2 class="text-sm font-semibold uppercase tracking-[0.2em] text-slate-300">Embed Snippet</h2>
          <button id="copyEmbedBtn"
            class="rounded-md bg-sky-500 px-3 py-1.5 text-xs font-semibold text-white transition hover:bg-sky-400">
            Copy Snippet
          </button>
        </div>
        <pre id="embedOutput"
          class="modern-scroll min-h-[66px] overflow-x-auto rounded-xl border border-white/10 bg-slate-900/70 p-3 text-xs text-slate-100"></pre>
      </article>
    </section>
  </main>

  <script>
    const defaultBase = localStorage.getItem('webterm_api_base') || 'http://127.0.0.1:5050';
    const defaultKey = '012345';

    const apiBaseInput = document.getElementById('apiBase');
    const apiKeyInput = document.getElementById('apiKey');
    const scanForm = document.getElementById('scanForm');
    const scanUrlInput = document.getElementById('scanUrl');
    const treeFilenameInput = document.getElementById('treeFilename');
    const responseList = document.getElementById('responseList');
    const actionMessage = document.getElementById('actionMessage');
    const connectionMessage = document.getElementById('connectionMessage');
    const connectionStatus = document.getElementById('connectionStatus');
    const treeOutput = document.getElementById('treeOutput');
    const embedOutput = document.getElementById('embedOutput');

    const statusBusy = document.getElementById('statusBusy');
    const statusRoot = document.getElementById('statusRoot');
    const statusPages = document.getElementById('statusPages');
    const statusItems = document.getElementById('statusItems');

    let treeViewMode = 'text';

    apiBaseInput.value = defaultBase;
    apiKeyInput.value = defaultKey;

    function getConfig() {
      return {
        apiBase: (apiBaseInput.value || '').trim().replace(/\/$/, ''),
        apiKey: (apiKeyInput.value || '').trim(),
      };
    }

    function normalizeUrl(value) {
      const raw = (value || '').trim();
      if (!raw) return '';
      if (/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw)) return raw;
      if (/^\/\//.test(raw)) return 'https:' + raw;
      return 'https://' + raw;
    }

    function getHeaders(json = false) {
      const cfg = getConfig();
      const headers = { 'X-API-Key': cfg.apiKey };
      if (json) headers['Content-Type'] = 'application/json';
      return headers;
    }

    function setMessage(text, error = false) {
      actionMessage.textContent = text;
      actionMessage.className = error ? 'mt-3 text-xs text-rose-300' : 'mt-3 text-xs text-emerald-300';
    }

    function setConnectionMessage(text, error = false) {
      connectionMessage.textContent = text;
      connectionMessage.className = error ? 'text-xs text-rose-300' : 'text-xs text-emerald-300';
    }

    function renderResponseList(items) {
      const array = Array.isArray(items) ? items : [];
      if (!array.length) {
        responseList.innerHTML = '<div data-empty-row="1" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-slate-300">No items yet.</div>';
        return;
      }

      for (const el of responseList.querySelectorAll('[data-empty-row="1"]')) {
        el.remove();
      }

      const existingRows = new Map();
      for (const row of responseList.querySelectorAll('[data-row-url]')) {
        existingRows.set(row.dataset.rowUrl, row);
      }

      const seen = new Set();
      for (const item of array) {
        const urlKey = String(item?.url || item?.text || Math.random());
        seen.add(urlKey);

        let row = existingRows.get(urlKey);
        if (!row) {
          row = document.createElement('div');
          row.dataset.rowUrl = urlKey;
          row.className = 'w-full max-w-full min-w-0 overflow-hidden rounded-xl border border-white/10 bg-white/5 p-3';
          row.innerHTML = `
            <div class="item-text mb-2 text-xs font-medium text-slate-100 break-words"></div>
            <div class="h-2 overflow-hidden rounded-full bg-slate-800">
              <div class="item-fill h-full rounded-full bg-gradient-to-r from-sky-400 to-emerald-400 transition-[width] duration-700 ease-out" style="width:0%"></div>
            </div>
          `;
        }

        const pct = Math.max(0, Math.min(100, Number(item?.progress || 0) * 100));
        const textEl = row.querySelector('.item-text');
        const fillEl = row.querySelector('.item-fill');
        if (textEl) textEl.textContent = item?.text || '';
        if (fillEl) fillEl.style.width = `${pct.toFixed(0)}%`;
        responseList.appendChild(row);
      }

      for (const [key, row] of existingRows.entries()) {
        if (!seen.has(key)) row.remove();
      }
    }

    async function fetchJson(path, options = {}) {
      const cfg = getConfig();
      const url = `${cfg.apiBase}${path}`;
      const response = await fetch(url, options);
      const data = await response.json().catch(() => ({}));
      return { response, data };
    }

    async function updateState() {
      try {
        const { response, data } = await fetchJson('/state', { headers: getHeaders() });
        if (!response.ok || !data.ok) {
          if (response.status === 401) {
            connectionStatus.textContent = 'Unauthorized';
            connectionStatus.className = 'text-xs text-rose-300';
            setConnectionMessage('API key mismatch. Use the same key in server and UI/widget.', true);
            return;
          }
          connectionStatus.textContent = 'Disconnected';
          connectionStatus.className = 'text-xs text-rose-300';
          return;
        }

        connectionStatus.textContent = 'Connected';
        connectionStatus.className = 'text-xs text-emerald-300';
        if (connectionMessage.textContent && connectionMessage.className.includes('rose')) {
          setConnectionMessage('');
        }

        statusBusy.innerHTML = data.busy
          ? '<span class="badge-dot bg-amber-400"></span>Scanning'
          : '<span class="badge-dot bg-emerald-400"></span>Idle';
        statusRoot.textContent = data.root_url || '-';
        statusPages.textContent = String(data.node_count || 0);
        statusItems.textContent = String(data.items_count || 0);
        embedOutput.textContent = data.embed_script || '';
      } catch {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'text-xs text-rose-300';
      }
    }

    async function updateList() {
      try {
        const { response, data } = await fetchJson('/list', { headers: getHeaders() });
        if (!response.ok || !data.ok) return;
        renderResponseList(data.items || []);
      } catch { }
    }

    async function updateTree() {
      try {
        const { response, data } = await fetchJson('/tree', { headers: getHeaders() });
        if (!response.ok || !data.ok) {
          treeOutput.textContent = 'No SiteTree available yet.';
          return;
        }

        if (treeViewMode === 'json') {
          treeOutput.textContent = JSON.stringify(data.tree_json || {}, null, 2);
        } else {
          treeOutput.textContent = data.tree_text || '';
        }
      } catch {
        treeOutput.textContent = 'Failed to load tree.';
      }
    }

    async function runScan(url) {
      const payload = { url: normalizeUrl(url) };
      const { response, data } = await fetchJson('/run', {
        method: 'POST',
        headers: getHeaders(true),
        body: JSON.stringify(payload),
      });

      if (!response.ok || !data.ok) {
        throw new Error(data.error || `Scan failed (${response.status})`);
      }

      renderResponseList(data.items || []);
    }

    async function postAction(path, body = {}) {
      const { response, data } = await fetchJson(path, {
        method: 'POST',
        headers: getHeaders(true),
        body: JSON.stringify(body),
      });
      if (!response.ok || !data.ok) {
        throw new Error(data.error || `${path} failed (${response.status})`);
      }
      return data;
    }

    scanForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const url = scanUrlInput.value.trim();
      if (!url) return;

      try {
        setMessage('Scanning started...');
        await runScan(url);
        await Promise.all([updateState(), updateList(), updateTree()]);
        setMessage('Scan request accepted.');
        scanUrlInput.value = '';
      } catch (error) {
        setMessage(error.message || 'Failed to start scan.', true);
      }
    });

    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      localStorage.setItem('webterm_api_base', getConfig().apiBase);
      localStorage.setItem('webterm_api_key', getConfig().apiKey);
      setConnectionMessage('Settings saved.');
      updateState();
      updateList();
      updateTree();
    });

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      await Promise.all([updateState(), updateList(), updateTree()]);
      setMessage('Refreshed.');
    });

    document.getElementById('refreshListBtn').addEventListener('click', updateList);
    document.getElementById('refreshTreeBtn').addEventListener('click', updateTree);

    document.getElementById('clearBtn').addEventListener('click', async () => {
      try {
        await postAction('/clear');
        await Promise.all([updateState(), updateList(), updateTree()]);
        setMessage('State cleared.');
      } catch (error) {
        setMessage(error.message || 'Failed to clear state.', true);
      }
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      try {
        const filename = treeFilenameInput.value.trim();
        const data = await postAction('/save', filename ? { filename } : {});
        setMessage(`Tree saved to ${data.filename}.`);
      } catch (error) {
        setMessage(error.message || 'Failed to save tree.', true);
      }
    });

    document.getElementById('loadBtn').addEventListener('click', async () => {
      try {
        const filename = treeFilenameInput.value.trim();
        if (!filename) {
          setMessage('Enter a filename to load.', true);
          return;
        }
        await postAction('/load', { filename });
        await Promise.all([updateState(), updateList(), updateTree()]);
        setMessage(`Loaded tree from ${filename}.`);
      } catch (error) {
        setMessage(error.message || 'Failed to load tree.', true);
      }
    });

    document.getElementById('treeTextBtn').addEventListener('click', async () => {
      treeViewMode = 'text';
      await updateTree();
    });

    document.getElementById('treeJsonBtn').addEventListener('click', async () => {
      treeViewMode = 'json';
      await updateTree();
    });

    document.getElementById('copyEmbedBtn').addEventListener('click', async () => {
      const text = embedOutput.textContent || '';
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setMessage('Embed snippet copied.');
      } catch {
        setMessage('Unable to copy embed snippet.', true);
      }
    });

    setInterval(() => {
      updateState();
      updateList();
    }, 1500);

    setInterval(updateTree, 3000);

    updateState();
    updateList();
    updateTree();
  </script>
</body>

</html>
